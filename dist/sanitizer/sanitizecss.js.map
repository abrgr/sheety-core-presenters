{"version":3,"sources":["../../src/sanitizer/sanitizecss.js"],"names":["cssPropBits","sanitizeCssProperty","undefined","sanitizeCssSelectorList","sanitizeStylesheet","sanitizeStylesheetWithExternals","sanitizeMediaQuery","NOEFFECT_URL","NORM_URL_REGEXP","NORM_URL_REPLACEMENTS","normalizeUrl","s","replace","normalizeUrlChar","ch","URI_SCHEME_RE","RegExp","ALLOWED_URI_SCHEMES","resolveUri","baseUri","uri","utils","resolve","safeUri","prop","naiveUriRewriter","parsed","match","test","withoutVendorPrefix","ident","unionArrays","arrs","map","i","length","arr","j","ALLOWED_LITERAL","sanitize","property","tokens","opt_naiveUriRewriter","opt_baseUri","opt_idSuffix","propertyKey","propertySchema","propBits","sanitizeFunctionCall","start","parenDepth","end","n","token","fnToken","toLowerCase","bareFnToken","fnTokens","splice","fns","nFns","substring","join","stringDisposition","CSS_PROP_BIT_URL","CSS_PROP_BIT_UNRESERVED_WORD","identDisposition","CSS_PROP_BIT_GLOBAL_NAME","CSS_PROP_BIT_PROPERTY_NAME","lastQuoted","NaN","k","cc","charCodeAt","cc1","cc2","isnum1","isnum2","litGroup","litMap","CSS_PROP_BIT_QSTRING","CSS_PROP_BIT_HASH_VALUE","CSS_PROP_BIT_QUANTITY","CSS_PROP_BIT_NEGATIVE_QUANTITY","charAt","PSEUDO_SELECTOR_WHITELIST","COMBINATOR","selectors","virtualization","opt_onUntranslatableSelector","containerClass","idSuffix","tagPolicy","sanitized","inBrackets","tok","processComplexSelector","out","lastOperator","valid","processCompoundSelector","combinator","element","classId","attrs","pseudoSelector","decision","vAttr","atype","ATTRIBS","rAttr","virtualizeAttrName","op","value","ignoreCase","selector","push","safeSelector","slice","MEDIA_TYPE","MEDIA_FEATURE","LENGTH_UNIT","CSS_VALUE","MEDIA_EXPR","MEDIA_QUERY","STARTS_WITH_KEYWORD_REGEXP","MEDIA_QUERY_LIST_REGEXP","cssTokens","nTokens","css","cssParseUri","candidate","string1","string2","url1","url2","url3","exec","sanitizeStylesheetInternal","cssText","naiveUriFetcher","continuation","opt_importCount","safeCss","importCount","blockStack","elide","atIdent","headerArray","animationId","mediaQuery","placeholder","cssUrl","result","html","safeImportedCss","toString","window","console","log","pop","checkElide","selectorArray","valueArray","isImportant","nValues","moreToCome"],"mappings":"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","file":"sanitizecss.js","sourcesContent":["/* eslint-disable */\n\n//\n// Translated From: https://raw.githubusercontent.com/google/caja/19e4f88478a5084f37c04e495739d2045492d9bb/src/com/google/caja/plugin/sanitizecss.js\n//\n\n// Copyright (C) 2011 Google Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview\n * JavaScript support for client-side CSS sanitization.\n * The CSS property schema API is defined in CssPropertyPatterns.java which\n * is used to generate css-defs.js.\n *\n * @author mikesamuel@gmail.com\n * \\@requires cssPropBits.CSS_PROP_BIT_GLOBAL_NAME\n * \\@requires cssPropBits.CSS_PROP_BIT_HASH_VALUE\n * \\@requires cssPropBits.CSS_PROP_BIT_NEGATIVE_QUANTITY\n * \\@requires cssPropBits.CSS_PROP_BIT_PROPERTY_NAME\n * \\@requires cssPropBits.CSS_PROP_BIT_QUANTITY\n * \\@requires cssPropBits.CSS_PROP_BIT_QSTRING\n * \\@requires cssPropBits.CSS_PROP_BIT_UNRESERVED_WORD\n * \\@requires cssPropBits.CSS_PROP_BIT_URL\n * \\@requires cssSchema\n * \\@requires decodeCss\n * \\@requires html4\n * \\@requires URI\n * \\@overrides window\n * \\@requires parseCssStylesheet\n * \\@provides sanitizeCssProperty\n * \\@provides sanitizeCssSelectorList\n * \\@provides sanitizeStylesheet\n * \\@provides sanitizeStylesheetWithExternals\n * \\@provides sanitizeMediaQuery\n */\n\nimport cssSchema, * as cssPropBits from './csspropbit';\nimport { decodeCss } from './csslexer';\nimport html4 from './html4';\nimport URI from './uri';\nimport { parseCssStylesheet } from './cssparser';\n\nvar sanitizeCssProperty = undefined;\nvar sanitizeCssSelectorList = undefined;\nvar sanitizeStylesheet = undefined;\nvar sanitizeStylesheetWithExternals = undefined;\nvar sanitizeMediaQuery = undefined;\n\n(function () {\n  var NOEFFECT_URL = 'url(\"about:blank\")';\n  /**\n   * The set of characters that need to be normalized inside url(\"...\").\n   * We normalize newlines because they are not allowed inside quoted strings,\n   * normalize quote characters, angle-brackets, and asterisks because they\n   * could be used to break out of the URL or introduce targets for CSS\n   * error recovery.  We normalize parentheses since they delimit unquoted\n   * URLs and calls and could be a target for error recovery.\n   */\n  var NORM_URL_REGEXP = /[\\n\\f\\r\\\"\\'()*<>]/g;\n  /** The replacements for NORM_URL_REGEXP. */\n  var NORM_URL_REPLACEMENTS = {\n    '\\n': '%0a',\n    '\\f': '%0c',\n    '\\r': '%0d',\n    '\"':  '%22',\n    '\\'': '%27',\n    '(':  '%28',\n    ')':  '%29',\n    '*':  '%2a',\n    '<':  '%3c',\n    '>':  '%3e'\n  };\n\n  function normalizeUrl(s) {\n    if ('string' === typeof s) {\n      return 'url(\"' + s.replace(NORM_URL_REGEXP, normalizeUrlChar) + '\")';\n    } else {\n      return NOEFFECT_URL;\n    }\n  }\n  function normalizeUrlChar(ch) {\n    return NORM_URL_REPLACEMENTS[ch];\n  }\n\n  // From RFC3986\n  var URI_SCHEME_RE = new RegExp(\n      '^' +\n      '(?:' +\n        '([^:\\/?# ]+)' +         // scheme\n      ':)?'\n  );\n\n  var ALLOWED_URI_SCHEMES = /^(?:https?|geo|mailto|sms|tel)$/i;\n\n  function resolveUri(baseUri, uri) {\n    if (baseUri) {\n      return URI.utils.resolve(baseUri, uri);\n    }\n    return uri;\n  }\n\n  function safeUri(uri, prop, naiveUriRewriter) {\n    if (!naiveUriRewriter) { return null; }\n    var parsed = ('' + uri).match(URI_SCHEME_RE);\n    if (parsed && (!parsed[1] || ALLOWED_URI_SCHEMES.test(parsed[1]))) {\n      return naiveUriRewriter(uri, prop);\n    } else {\n      return null;\n    }\n  }\n\n  function withoutVendorPrefix(ident) {\n    // http://stackoverflow.com/a/5411098/20394 has a fairly extensive list\n    // of vendor prefices.\n    // Blink has not declared a vendor prefix distinct from -webkit-\n    // and http://css-tricks.com/tldr-on-vendor-prefix-drama/ discusses\n    // how Mozilla recognizes some -webkit-\n    // http://wiki.csswg.org/spec/vendor-prefixes talks more about\n    // cross-implementation, and lists other prefixes.\n    // Note: info is duplicated in CssValidator.java\n    return ident.replace(\n        /^-(?:apple|css|epub|khtml|moz|mso?|o|rim|wap|webkit|xv)-(?=[a-z])/, '');\n  }\n\n  /**\n   * Given a series of normalized CSS tokens, applies a property schema, as\n   * defined in CssPropertyPatterns.java, and sanitizes the tokens in place.\n   * @param property a property name.\n   * @param tokens as parsed by lexCss.  Modified in place.\n   * @param opt_naiveUriRewriter a URI rewriter; an object with a \"rewrite\"\n   *     function that takes a URL and returns a safe URL.\n   * @param opt_baseURI a URI against which all relative URLs in tokens will\n   *     be resolved.\n   * @param opt_idSuffix {string} appended to all IDs to scope them.\n   */\n  sanitizeCssProperty = (function () {\n\n    function unionArrays(arrs) {\n      var map = {};\n      for (var i = arrs.length; --i >= 0;) {\n        var arr = arrs[i];\n        for (var j = arr.length; --j >= 0;) {\n          map[arr[j]] = ALLOWED_LITERAL;\n        }\n      }\n      return map;\n    }\n\n    // Used as map value to avoid hasOwnProperty checks.\n    var ALLOWED_LITERAL = {};\n\n    return function sanitize(\n        property, tokens, opt_naiveUriRewriter, opt_baseUri, opt_idSuffix) {\n\n      var propertyKey = withoutVendorPrefix(property);\n      var propertySchema = cssSchema[propertyKey];\n\n      // If the property isn't recognized, elide all tokens.\n      if (!propertySchema || 'object' !== typeof propertySchema) {\n        tokens.length = 0;\n        return;\n      }\n\n      var propBits = propertySchema['cssPropBits'];\n\n      /**\n       * Recurse to apply the appropriate function schema to the function call\n       * that starts at {@code tokens[start]}.\n       * @param {Array.<string>} tokens an array of CSS token that is modified\n       *   in place so that all tokens involved in the function call\n       *   (from {@code tokens[start]} to a close parenthesis) are folded to\n       *   one token.\n       * @param {number} start an index into tokens of a function token like\n       *   {@code 'name('}.\n       * @return the replacement function or the empty string if the function\n       *   call is not both well-formed and allowed.\n       */\n      function sanitizeFunctionCall(tokens, start) {\n        var parenDepth = 1, end = start + 1, n = tokens.length;\n        while (end < n && parenDepth) {\n          var token = tokens[end++];\n          // Decrement if we see a close parenthesis, and increment if we\n          // see a function.  Since url(...) are whole tokens, they will not\n          // affect the token scanning.\n          parenDepth += (token === ')' ? -1 : /^[^\"']*\\($/.test(token));\n        }\n        // Allow error-recovery from unclosed functions by ignoring the call and\n        // so allowing resumption at the next ';'.\n        if (!parenDepth) {\n          var fnToken = tokens[start].toLowerCase();\n          var bareFnToken = withoutVendorPrefix(fnToken);\n          // Cut out the originals, so the caller can step by one token.\n          var fnTokens = tokens.splice(start, end - start, '');\n          var fns = propertySchema['cssFns'];\n          // Look for a function that matches the name.\n          for (var i = 0, nFns = fns.length; i < nFns; ++i) {\n            if (fns[i].substring(0, bareFnToken.length) == bareFnToken) {\n              fnTokens[0] = fnTokens[fnTokens.length - 1] = '';\n              // Recurse and sanitize the function parameters.\n              sanitize(\n                fns[i],\n                // The actual parameters to the function.\n                fnTokens,\n                opt_naiveUriRewriter, opt_baseUri);\n              // Reconstitute the function from its parameter tokens.\n              return fnToken + fnTokens.join(' ') + ')';\n            }\n          }\n        }\n        return '';\n      }\n\n      // Used to determine whether to treat quoted strings as URLs or\n      // plain text content, and whether unrecognized keywords can be quoted\n      // to treat ['Arial', 'Black'] equivalently to ['\"Arial Black\"'].\n      var stringDisposition =\n        propBits & (cssPropBits.CSS_PROP_BIT_URL | cssPropBits.CSS_PROP_BIT_UNRESERVED_WORD);\n      // Used to determine what to do with unreserved words.\n      var identDisposition =\n        propBits & (cssPropBits.CSS_PROP_BIT_GLOBAL_NAME | cssPropBits.CSS_PROP_BIT_PROPERTY_NAME);\n\n      // Used to join unquoted keywords into a single quoted string.\n      var lastQuoted = NaN;\n      var i = 0, k = 0;\n      for (;i < tokens.length; ++i) {\n        // Has the effect of normalizing hex digits, keywords,\n        // and function names.\n        var token = tokens[i].toLowerCase();\n        var cc = token.charCodeAt(0), cc1, cc2, isnum1, isnum2, end;\n        var litGroup, litMap;\n        token = (\n\n          // Strip out spaces.  Normally cssparser.js dumps these, but we\n          // strip them out in case the content doesn't come via cssparser.js.\n          (cc === ' '.charCodeAt(0)) ? ''\n          : (cc === '\"'.charCodeAt(0)) ? (  // Quoted string.\n            (stringDisposition === cssPropBits.CSS_PROP_BIT_URL)\n            ? (opt_naiveUriRewriter\n               // Sanitize and convert to url(\"...\") syntax.\n               // Treat url content as case-sensitive.\n               ? (normalizeUrl(\n                   // Rewrite to a safe URI.\n                   safeUri(\n                     // Convert to absolute URL\n                     resolveUri(\n                       opt_baseUri,\n                       // Strip off quotes\n                       decodeCss(tokens[i].substring(1, token.length - 1))),\n                     propertyKey,\n                     opt_naiveUriRewriter)))\n              : '')\n            : ((propBits & cssPropBits.CSS_PROP_BIT_QSTRING)\n               // Ambiguous when more than one bit set in disposition.\n               && !(stringDisposition & (stringDisposition - 1)))\n            ? token\n            // Drop if quoted strings not allowed.\n            : ''\n          )\n\n          // inherit is always allowed.\n          : token === 'inherit'\n          ? token\n\n          : (\n            litGroup = propertySchema['cssLitGroup'],\n            litMap = (litGroup\n                      ? (propertySchema['cssLitMap']\n                         // Lazily compute the union from litGroup.\n                         || (propertySchema['cssLitMap'] =\n                             unionArrays(litGroup)))\n                      : ALLOWED_LITERAL),  // A convenient empty object.\n            (litMap[withoutVendorPrefix(token)] === ALLOWED_LITERAL)\n          )\n          // Token is in the literal map or matches extra.\n          ? token\n\n          // Preserve hash color literals if allowed.\n          : (cc === '#'.charCodeAt(0) && /^#(?:[0-9a-f]{3,4}){1,2}$/.test(token))\n          ? (propBits & cssPropBits.CSS_PROP_BIT_HASH_VALUE ? token : '')\n\n          : ('0'.charCodeAt(0) <= cc && cc <= '9'.charCodeAt(0))\n          // A number starting with a digit.\n          ? ((propBits & cssPropBits.CSS_PROP_BIT_QUANTITY) ? token : '')\n\n          // Normalize quantities so they don't start with a '.' or '+' sign and\n          // make sure they all have an integer component so can't be confused\n          // with a dotted identifier.\n          // This can't be done in the lexer since \".4\" is a valid rule part.\n          : (cc1 = token.charCodeAt(1),\n             cc2 = token.charCodeAt(2),\n             isnum1 = '0'.charCodeAt(0) <= cc1 && cc1 <= '9'.charCodeAt(0),\n             isnum2 = '0'.charCodeAt(0) <= cc2 && cc2 <= '9'.charCodeAt(0),\n             // +.5 -> 0.5 if allowed.\n             (cc === '+'.charCodeAt(0)\n              && (isnum1 || (cc1 === '.'.charCodeAt(0) && isnum2))))\n          ? ((propBits & cssPropBits.CSS_PROP_BIT_QUANTITY)\n            ? ((isnum1 ? '' : '0') + token.substring(1))\n            : '')\n\n          // -.5 -> -0.5 if allowed otherwise -> 0 if quantities allowed.\n          : (cc === '-'.charCodeAt(0)\n             && (isnum1 || (cc1 === '.'.charCodeAt(0) && isnum2)))\n            ? ((propBits & cssPropBits.CSS_PROP_BIT_NEGATIVE_QUANTITY)\n               ? ((isnum1 ? '-' : '-0') + token.substring(1))\n               : ((propBits & cssPropBits.CSS_PROP_BIT_QUANTITY) ? '0' : ''))\n\n          // .5 -> 0.5 if allowed.\n          : (cc === '.'.charCodeAt(0) && isnum1)\n          ? ((propBits & cssPropBits.CSS_PROP_BIT_QUANTITY) ? '0' + token : '')\n\n          // Handle url(\"...\") by rewriting the body.\n          : ('url(\"' === token.substring(0, 5))\n          ? ((opt_naiveUriRewriter && (propBits & cssPropBits.CSS_PROP_BIT_URL))\n             ? normalizeUrl(safeUri(resolveUri(opt_baseUri,\n                  tokens[i].substring(5, token.length - 2)),\n                  propertyKey,\n                  opt_naiveUriRewriter))\n             : '')\n\n          // Handle func(...) by recursing.\n          // Functions start at a token like \"name(\" and end with a \")\" taking\n          // into account nesting.\n          : (token.charAt(token.length-1) === '(')\n          ? sanitizeFunctionCall(tokens, i)\n\n          : (identDisposition\n             && /^-?[a-z_][\\w\\-]*$/.test(token) && !/__$/.test(token))\n          ? (opt_idSuffix && identDisposition === cssPropBits.CSS_PROP_BIT_GLOBAL_NAME\n             ? tokens[i] + opt_idSuffix  // use original token, not lowercased\n             : (identDisposition === cssPropBits.CSS_PROP_BIT_PROPERTY_NAME\n                && cssSchema[token]\n                && 'number' === typeof cssSchema[token].cssPropBits)\n             ? token\n             : '')\n\n          : (/^\\w+$/.test(token)\n             && stringDisposition === cssPropBits.CSS_PROP_BIT_UNRESERVED_WORD\n             && (propBits & cssPropBits.CSS_PROP_BIT_QSTRING))\n          // Quote unrecognized keywords so font names like\n          //    Arial Bold\n          // ->\n          //    \"Arial Bold\"\n          ? (lastQuoted+1 === k\n             // If the last token was also a keyword that was quoted, then\n             // combine this token into that.\n             ? (tokens[lastQuoted] = (\n                  tokens[lastQuoted].substring(0, tokens[lastQuoted].length-1)\n                  + ' ' + token + '\"'),\n                token = '')\n             : (lastQuoted = k, '\"' + token + '\"'))\n\n          // Disallowed.\n          : '');\n        if (token) {\n          tokens[k++] = token;\n        }\n      }\n      // For single URL properties, if the URL failed to pass the sanitizer,\n      // then just drop it.\n      if (k === 1 && tokens[0] === NOEFFECT_URL) { k = 0; }\n      tokens.length = k;\n    };\n  })();\n\n  // Note, duplicated in CssRewriter.java\n  // Constructed from\n  //    https://developer.mozilla.org/en-US/docs/Web/CSS/Reference\n  //    https://developer.mozilla.org/en-US/docs/Web/CSS/Pseudo-classes\n  //    http://dev.w3.org/csswg/selectors4/\n  var PSEUDO_SELECTOR_WHITELIST =\n    new RegExp(\n        '^(active|after|before|blank|checked|default|disabled'\n        + '|drop|empty|enabled|first|first-child|first-letter'\n        + '|first-line|first-of-type|fullscreen|focus|hover'\n        + '|in-range|indeterminate|invalid|last-child|last-of-type'\n        + '|left|link|only-child|only-of-type|optional|out-of-range'\n        + '|placeholder-shown|read-only|read-write|required|right'\n        + '|root|scope|user-error|valid|visited'\n        + ')$');\n\n  // Set of punctuation tokens that are child/sibling selectors.\n  var COMBINATOR = {};\n  COMBINATOR['>'] = COMBINATOR['+'] = COMBINATOR['~'] = COMBINATOR;\n\n  /**\n   * Given a series of tokens, returns a list of sanitized selectors.\n   * @param {Array.<string>} selectors In the form produced by csslexer.js.\n   * @param {{\n   *     containerClass: ?string,\n   *     idSuffix: string,\n   *     tagPolicy: defs.TagPolicy,\n   *     virtualizeAttrName: ?function(string, string): ?string\n   *   }} virtualization An object like <pre<{\n   *   containerClass: class name prepended to all selectors to scope them (if\n   *       not null)\n   *   idSuffix: appended to all IDs to scope them\n   *   tagPolicy: As in html-sanitizer, used for rewriting element names.\n   *   virtualizeAttrName: Rewrite a single attribute name for attribute\n   *       selectors, or return null if not possible. Should be consistent\n   *       with tagPolicy if possible.\n   * }</pre>\n   *    If containerClass is {@code \"sfx\"} and idSuffix is {@code \"-sfx\"}, the\n   *    selector\n   *    {@code [\"a\", \"#foo\", \" \", \"b\", \".bar\"]} will be namespaced to\n   *    {@code [\".sfx\", \" \", \"a\", \"#foo-sfx\", \" \", \"b\", \".bar\"]}.\n   * @param {function(Array.<string>): boolean} opt_onUntranslatableSelector\n   *     When a selector cannot be translated, this function is called with the\n   *     non-whitespace/comment tokens comprising the selector and returns a\n   *     value indicating whether to continue processing the selector list.\n   *     If it returns falsey, then processing is aborted and null is returned.\n   *     If not present or it returns truthy, then the complex selector is\n   *     dropped from the selector list.\n   * @return {Array.<string>}? an array of sanitized selectors.\n   *    Null when the untraslatable compound selector handler aborts processing.\n   */\n  sanitizeCssSelectorList = function(\n      selectors, virtualization, opt_onUntranslatableSelector) {\n    var containerClass = virtualization.containerClass;\n    var idSuffix = virtualization.idSuffix;\n    var tagPolicy = virtualization.tagPolicy;\n    var sanitized = [];\n\n    // Remove any spaces that are not operators.\n    var k = 0, i, inBrackets = 0, tok;\n    for (i = 0; i < selectors.length; ++i) {\n      tok = selectors[i];\n\n      if (\n            (tok == '(' || tok == '[') ? (++inBrackets, true)\n          : (tok == ')' || tok == ']') ? (inBrackets && --inBrackets, true)\n          : !(selectors[i] == ' '\n              && (inBrackets || COMBINATOR[selectors[i-1]] === COMBINATOR\n                  || COMBINATOR[selectors[i+1]] === COMBINATOR))\n        ) {\n        selectors[k++] = selectors[i];\n      }\n    }\n    selectors.length = k;\n\n    // Split around commas.  If there is an error in one of the comma separated\n    // bits, we throw the whole away, but the failure of one selector does not\n    // affect others except that opt_onUntranslatableSelector allows one to\n    // treat the entire output as unusable.\n    var n = selectors.length, start = 0;\n    for (i = 0; i < n; ++i) {\n      if (selectors[i] === ',') {  // TODO: ignore ',' inside brackets.\n        if (!processComplexSelector(start, i)) { return null; }\n        start = i+1;\n      }\n    }\n    if (!processComplexSelector(start, n)) { return null; }\n\n\n    function processComplexSelector(start, end) {\n      // Space around commas is not an operator.\n      if (selectors[start] === ' ') { ++start; }\n      if (end-1 !== start && selectors[end] === ' ') { --end; }\n\n      // Split the selector into element selectors, content around\n      // space (ancestor operator) and '>' (descendant operator).\n      var out = [];\n      var lastOperator = start;\n      var valid = true;  // True iff out contains a valid complex selector.\n      for (var i = start; valid && i < end; ++i) {\n        var tok = selectors[i];\n        if (COMBINATOR[tok] === COMBINATOR || tok === ' ') {\n          // We've found the end of a single link in the selector chain.\n          if (!processCompoundSelector(lastOperator, i, tok)) {\n            valid = false;\n          } else {\n            lastOperator = i+1;\n          }\n        }\n      }\n      if (!processCompoundSelector(lastOperator, end, '')) {\n        valid = false;\n      }\n\n      function processCompoundSelector(start, end, combinator) {\n        // Split the element selector into four parts.\n        // DIV.foo#bar[href]:hover\n        //    ^       ^     ^\n        // el classes attrs pseudo\n        var element, classId, attrs, pseudoSelector,\n            tok,  // The current token\n            // valid implies the parts above comprise a sanitized selector.\n            valid = true;\n        element = '';\n        if (start < end) {\n          tok = selectors[start];\n          if (tok === '*') {\n            ++start;\n            element = tok;\n          } else if (/^[a-zA-Z]/.test(tok)) {  // is an element selector\n            var decision = tagPolicy(tok.toLowerCase(), []);\n            if (decision) {\n              if ('tagName' in decision) {\n                tok = decision['tagName'];\n              }\n              ++start;\n              element = tok;\n            }\n          }\n        }\n        classId = '';\n        attrs = '';\n        pseudoSelector = '';\n        for (;valid && start < end; ++start) {\n          tok = selectors[start];\n          if (tok.charAt(0) === '#') {\n            if (/^#_|__$|[^\\w#:\\-]/.test(tok)) {\n              valid = false;\n            } else {\n              // Rewrite ID elements to include the suffix.\n              classId += tok + idSuffix;\n            }\n          } else if (tok === '.') {\n            if (++start < end\n                && /^[0-9A-Za-z:_\\-]+$/.test(tok = selectors[start])\n                && !/^_|__$/.test(tok)) {\n              classId += '.' + tok;\n            } else {\n              valid = false;\n            }\n          } else if (start + 1 < end && selectors[start] === '[') {\n            ++start;\n            var vAttr = selectors[start++].toLowerCase();\n            // Schema lookup for type information\n            var atype = html4.ATTRIBS[element + '::' + vAttr];\n            if (atype !== +atype) { atype = html4.ATTRIBS['*::' + vAttr]; }\n\n            var rAttr;\n            // Consult policy\n            // TODO(kpreid): Making this optional is a kludge to avoid changing\n            // the public interface until we have a more well-structured design.\n            if (virtualization.virtualizeAttrName) {\n              rAttr = virtualization.virtualizeAttrName(element, vAttr);\n              if (typeof rAttr !== 'string') {\n                // rejected\n                valid = false;\n                rAttr = vAttr;\n              }\n              // don't reject even if not in schema\n              if (valid && atype !== +atype) {\n                atype = html4.atype['NONE'];\n              }\n            } else {\n              rAttr = vAttr;\n              if (atype !== +atype) {  // not permitted according to schema\n                valid = false;\n              }\n            }\n\n            var op = '', value = '', ignoreCase = false;\n            if (/^[~^$*|]?=$/.test(selectors[start])) {\n              op = selectors[start++];\n              value = selectors[start++];\n              // Quote identifier values.\n              if (/^[0-9A-Za-z:_\\-]+$/.test(value)) {\n                value = '\"' + value + '\"';\n              } else if (value === ']') {\n                value = '\"\"';\n                --start;\n              }\n              // Reject unquoted values.\n              if (!/^\"([^\\\"\\\\]|\\\\.)*\"$/.test(value)) {\n                valid = false;\n              }\n              ignoreCase = selectors[start] === \"i\";\n              if (ignoreCase) { ++start; }\n            }\n            if (selectors[start] !== ']') {\n              ++start;\n              valid = false;\n            }\n            // TODO: replace this with a lookup table that also provides a\n            // function from operator and value to testable value.\n            switch (atype) {\n            case html4.atype['CLASSES']:\n            case html4.atype['LOCAL_NAME']:\n            case html4.atype['NONE']:\n              break;\n            case html4.atype['GLOBAL_NAME']:\n            case html4.atype['ID']:\n            case html4.atype['IDREF']:\n              if ((op === '=' || op === '~=' || op === '$=')\n                  && value != '\"\"' && !ignoreCase) {\n                // The suffix is case-sensitive, so we can't translate case\n                // ignoring matches.\n                value = '\"'\n                  + value.substring(1, value.length-1) + idSuffix\n                  + '\"';\n              } else if (op === '|=' || op === '') {\n                // Ok.  a|=b -> a == b || a.startsWith(b + \"-\") and since we\n                // use \"-\" to separate the suffix from the identifier, we can\n                // allow this through unmodified.\n                // Existence checks are also ok.\n              } else {\n                // Can't correctly handle prefix and substring operators\n                // without leaking information about the suffix.\n                valid = false;\n              }\n              break;\n            case html4.atype['URI']:\n            case html4.atype['URI_FRAGMENT']:\n              // URIs are rewritten, so we can't meanginfully translate URI\n              // selectors besides the common a[href] one that is used to\n              // distinguish links from naming anchors.\n              if (op !== '') { valid = false; }\n              break;\n            // TODO: IDREFS\n            default:\n              valid = false;\n            }\n            if (valid) {\n              attrs += '[' + rAttr.replace(/[^\\w-]/g, '\\\\$&') + op + value +\n                  (ignoreCase ? ' i]' : ']');\n            }\n          } else if (start < end && selectors[start] === ':') {\n            tok = selectors[++start];\n            if (PSEUDO_SELECTOR_WHITELIST.test(tok)) {\n              pseudoSelector += ':' + tok;\n            } else {\n              break;\n            }\n          } else {\n            break;  // Unrecognized token.\n          }\n        }\n        if (start !== end) {  // Tokens not consumed.\n          valid = false;\n        }\n        if (valid) {\n          // ':' is allowed in identifiers, but is also the\n          // pseudo-selector separator, so ':' in preceding parts needs to\n          // be escaped.\n          var selector = (element + classId).replace(/[^ .*#\\w-]/g, '\\\\$&')\n              + attrs + pseudoSelector + combinator;\n          if (selector) { out.push(selector); }\n        }\n        return valid;\n      }\n\n      if (valid) {\n        if (out.length) {\n          var safeSelector = out.join('');\n\n          // Namespace the selector so that it only matches under\n          // a node with suffix in its CLASS attribute.\n          if (containerClass !== null) {\n            safeSelector = '.' + containerClass + ' ' + safeSelector;\n          }\n\n          sanitized.push(safeSelector);\n        }  // else nothing there.\n        return true;\n      } else {\n        return !opt_onUntranslatableSelector\n          || opt_onUntranslatableSelector(selectors.slice(start, end));\n      }\n    }\n    return sanitized;\n  };\n\n  (function () {\n    var MEDIA_TYPE =\n       '(?:'\n       + 'all|aural|braille|embossed|handheld|print'\n       + '|projection|screen|speech|tty|tv'\n       + ')';\n\n    // A white-list of media features extracted from the \"Pseudo-BNF\" in\n    // http://dev.w3.org/csswg/mediaqueries4/#media1 and\n    // https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Media_queries\n    var MEDIA_FEATURE =\n       '(?:'\n       + '(?:min-|max-)?'\n       + '(?:' + (\n           '(?:device-)?'\n         + '(?:aspect-ratio|height|width)'\n         + '|color(?:-index)?'\n         + '|monochrome'\n         + '|orientation'\n         + '|resolution'\n       )\n       + ')'\n       + '|grid'\n       + '|hover'\n       + '|luminosity'\n       + '|pointer'\n       + '|scan'\n       + '|script'\n       + ')';\n\n    var LENGTH_UNIT = '(?:p[cxt]|[cem]m|in|dpi|dppx|dpcm|%)';\n\n    var CSS_VALUE =\n       '-?(?:'\n       + '[a-z]\\\\w+(?:-\\\\w+)*'  // An identifier\n       // A length or scalar quantity, or a rational number.\n       // dev.w3.org/csswg/mediaqueries4/#values introduces a ratio value-type\n       // to allow matching aspect ratios like \"4 / 3\".\n       + '|\\\\d+(?: / \\\\d+|(?:\\\\.\\\\d+)?' + LENGTH_UNIT + '?)'\n       + ')';\n\n    var MEDIA_EXPR =\n       '\\\\( ' + MEDIA_FEATURE + ' (?:' + ': ' + CSS_VALUE + ' )?\\\\)';\n\n    var MEDIA_QUERY =\n       '(?:'\n       + '(?:(?:(?:only|not) )?' + MEDIA_TYPE + '|' + MEDIA_EXPR + ')'\n       // We use 'and ?' since 'and(' is a single CSS function token while\n       // 'and (' parses to two separate tokens -- IDENT \"and\", DELIM \"(\".\n       + '(?: and ?' + MEDIA_EXPR + ')*'\n       + ')';\n\n    var STARTS_WITH_KEYWORD_REGEXP = /^\\w/;\n\n    var MEDIA_QUERY_LIST_REGEXP = new RegExp(\n      '^' + MEDIA_QUERY + '(?: , ' + MEDIA_QUERY + ')*' + '$',\n      'i'\n    );\n\n    /**\n     * Sanitizes a media query as defined in\n     * http://dev.w3.org/csswg/mediaqueries4/#syntax\n     * <blockquote>\n     * Media Queries allow authors to adapt the style applied to a document\n     * based on the environment the document is being rendered in.\n     * </blockquote>\n     *\n     * @param {Array.<string>} cssTokens an array of tokens of the kind produced\n     *   by cssLexers.\n     * @return {string} a CSS media query.  This may be the empty string, or if\n     *   the input is invalid, then a query that is always false.\n     */\n    sanitizeMediaQuery = function (cssTokens) {\n      cssTokens = cssTokens.slice();\n      // Strip out space tokens.\n      var nTokens = cssTokens.length, k = 0;\n      for (var i = 0; i < nTokens; ++i) {\n        var tok = cssTokens[i];\n        if (tok != ' ') { cssTokens[k++] = tok; }\n      }\n      cssTokens.length = k;\n      var css = cssTokens.join(' ');\n      css = (\n        !css.length ? ''  // Always true per the spec.\n        : !(MEDIA_QUERY_LIST_REGEXP.test(css)) ? 'not all'  // Always false.\n        // Emit as-is if it starts with 'only', 'not' or a media type.\n        : STARTS_WITH_KEYWORD_REGEXP.test(css) ? css\n        : 'not all , ' + css  // Not ambiguous with a URL.\n      );\n      return css;\n    };\n  }());\n\n  (function () {\n\n    /**\n     * Extracts a url out of an at-import rule of the form:\n     *   \\@import \"mystyle.css\";\n     *   \\@import url(\"mystyle.css\");\n     *\n     * Returns null if no valid url was found.\n     */\n    function cssParseUri(candidate) {\n      var string1 = /^\\s*[\"]([^\"]*)[\"]\\s*$/;\n      var string2 = /^\\s*[']([^']*)[']\\s*$/;\n      var url1 = /^\\s*url\\s*[(][\"]([^\"]*)[\"][)]\\s*$/;\n      var url2 = /^\\s*url\\s*[(][']([^']*)['][)]\\s*$/;\n      // Not officially part of the CSS2.1 grammar\n      // but supported by Chrome\n      var url3 = /^\\s*url\\s*[(]([^)]*)[)]\\s*$/;\n      var match;\n      if ((match = string1.exec(candidate))) {\n        return match[1];\n      } else if ((match = string2.exec(candidate))) {\n        return match[1];\n      } else if ((match = url1.exec(candidate))) {\n        return match[1];\n      } else if ((match = url2.exec(candidate))) {\n        return match[1];\n      } else if ((match = url3.exec(candidate))) {\n        return match[1];\n      }\n      return null;\n    }\n\n    /**\n     * @param {string} baseUri a string against which relative urls are\n     *    resolved.\n     * @param {string} cssText a string containing a CSS stylesheet.\n     * @param {{\n     *     containerClass: ?string,\n     *     idSuffix: string,\n     *     tagPolicy: defs.TagPolicy,\n     *     virtualizeAttrName: ?function(string, string): ?string\n     *   }} virtualization An object like <pre<{\n     *   containerClass: class name prepended to all selectors to scope them (if\n     *       not null)\n     *   idSuffix: appended to all IDs to scope them\n     *   tagPolicy: As in html-sanitizer, used for rewriting element names.\n     *   virtualizeAttrName: Rewrite a single attribute name for attribute\n     *       selectors, or return null if not possible. Should be consistent\n     *       with tagPolicy if possible. Optional.\n     * }</pre>\n     *    If containerClass is {@code \"sfx\"} and idSuffix is {@code \"-sfx\"}, the\n     *    selector\n     *    {@code [\"a\", \"#foo\", \" \", \"b\", \".bar\"]} will be namespaced to\n     *    {@code [\".sfx\", \" \", \"a\", \"#foo-sfx\", \" \", \"b\", \".bar\"]}.\n     * @param {function(string, string)} naiveUriRewriter maps URLs of media\n     *    (images, sounds) that appear as CSS property values to sanitized\n     *    URLs or null if the URL should not be allowed as an external media\n     *    file in sanitized CSS.\n     * @param {undefined|function({toString: function ():string}, boolean)}\n     *     continuation\n     *     callback that receives the result of loading imported CSS.\n     *     The callback is called with\n     *     (cssContent : function ():string, moreToCome : boolean)\n     *     where cssContent is the CSS at the imported URL, and moreToCome is\n     *     true when the external URL itself loaded other external URLs.\n     *     If the output of the original call is stringified when moreToCome is\n     *     false, then it will be complete.\n     * @param {Array.<number>} opt_importCount the number of imports that need\n     *     to be satisfied before there is no more pending content.\n     * @return {{result:{toString:function ():string},moreToCome:boolean}}\n     *     the CSS text, and a flag that indicates whether there are pending\n     *     imports that will be passed to continuation.\n     */\n    function sanitizeStylesheetInternal(\n        baseUri, cssText, virtualization, naiveUriRewriter, naiveUriFetcher,\n        continuation, opt_importCount) {\n      var safeCss = void 0;\n      // Return a result with moreToCome===true when the last import has been\n      // sanitized.\n      var importCount = opt_importCount || [0];\n      // A stack describing the { ... } regions.\n      // Null elements indicate blocks that should not be emitted.\n      var blockStack = [];\n      // True when the content of the current block should be left off safeCss.\n      var elide = false;\n      parseCssStylesheet(\n          cssText,\n          {\n            'startStylesheet': function () {\n              safeCss = [];\n            },\n            'endStylesheet': function () {\n            },\n            'startAtrule': function (atIdent, headerArray) {\n              if (elide) {\n                atIdent = null;\n              } else if (atIdent === '@media') {\n                safeCss.push('@media', ' ', sanitizeMediaQuery(headerArray));\n              } else if (atIdent === '@keyframes'\n                         || atIdent === '@-webkit-keyframes') {\n                var animationId = headerArray[0];\n                if (headerArray.length === 1\n                    && !/__$|[^\\w\\-]/.test(animationId)) {\n                  safeCss.push(\n                      atIdent, ' ', animationId + virtualization.idSuffix);\n                  atIdent = '@keyframes';\n                } else {\n                  atIdent = null;\n                }\n              } else {\n                if (atIdent === '@import' && headerArray.length > 0) {\n                  atIdent = null;\n                  if ('function' === typeof continuation) {\n                    var mediaQuery = sanitizeMediaQuery(headerArray.slice(1));\n                    if (mediaQuery !== 'not all') {\n                      ++importCount[0];\n                      var placeholder = [];\n                      safeCss.push(placeholder);\n                      var cssUrl = safeUri(\n                          resolveUri(baseUri, cssParseUri(headerArray[0])),\n                          function(result) {\n                            var sanitized = sanitizeStylesheetInternal(\n                                cssUrl, result.html, virtualization,\n                                naiveUriRewriter, naiveUriFetcher,\n                                continuation, importCount);\n                            --importCount[0];\n                            var safeImportedCss = mediaQuery\n                              ? {\n                                toString: function () {\n                                  return (\n                                    '@media ' + mediaQuery + ' {'\n                                    + sanitized.result + '}'\n                                  );\n                                }\n                              }\n                              : sanitized.result;\n                            placeholder[0] = safeImportedCss;\n                            continuation(safeImportedCss, !!importCount[0]);\n                          },\n                          naiveUriFetcher);\n                    }\n                  } else {\n                    // TODO: Use a logger instead.\n                    if (window.console) {\n                      window.console.log(\n                          '@import ' + headerArray.join(' ') + ' elided');\n                    }\n                  }\n                }\n              }\n              elide = !atIdent;\n              blockStack.push(atIdent);\n            },\n            'endAtrule': function () {\n              blockStack.pop();\n              if (!elide) {\n                safeCss.push(';');\n              }\n              checkElide();\n            },\n            'startBlock': function () {\n              // There are no bare blocks in CSS, so we do not change the\n              // block stack here, but instead in the events that bracket\n              // blocks.\n              if (!elide) {\n                safeCss.push('{');\n              }\n            },\n            'endBlock': function () {\n              if (!elide) {\n                safeCss.push('}');\n                elide = true;  // skip any semicolon from endAtRule.\n              }\n            },\n            'startRuleset': function (selectorArray) {\n              if (!elide) {\n                var selector = void 0;\n                if (blockStack[blockStack.length - 1] === '@keyframes') {\n                  // Allow [from | to | <percentage>]\n                  selector = selectorArray.join(' ')\n                    .match(/^ *(?:from|to|\\d+(?:\\.\\d+)?%) *(?:, *(?:from|to|\\d+(?:\\.\\d+)?%) *)*$/i);\n                  elide = !selector;\n                  if (selector) { selector = selector[0].replace(/ +/g, ''); }\n                } else {\n                  var selectors = sanitizeCssSelectorList(\n                      selectorArray, virtualization);\n                  if (!selectors || !selectors.length) {\n                    elide = true;\n                  } else {\n                    selector = selectors.join(', ');\n                  }\n                }\n                if (!elide) {\n                  safeCss.push(selector, '{');\n                }\n              }\n              blockStack.push(null);\n            },\n            'endRuleset': function () {\n              blockStack.pop();\n              if (!elide) {\n                safeCss.push('}');\n              }\n              checkElide();\n            },\n            'declaration': function (property, valueArray) {\n              if (!elide) {\n                var isImportant = false;\n                var nValues = valueArray.length;\n                if (nValues >= 2\n                    && valueArray[nValues - 2] === '!'\n                    && valueArray[nValues - 1].toLowerCase() === 'important') {\n                  isImportant = true;\n                  valueArray.length -= 2;\n                }\n                sanitizeCssProperty(\n                    property, valueArray, naiveUriRewriter, baseUri,\n                    virtualization.idSuffix);\n                if (valueArray.length) {\n                  safeCss.push(\n                      property, ':', valueArray.join(' '),\n                      isImportant ? ' !important;' : ';');\n                }\n              }\n            }\n          });\n      function checkElide() {\n        elide = blockStack.length && blockStack[blockStack.length-1] === null;\n      }\n      return {\n        result : { toString: function () { return safeCss.join(''); } },\n        moreToCome : !!importCount[0]\n      };\n    }\n\n    sanitizeStylesheet = function (\n        baseUri, cssText, virtualization, naiveUriRewriter) {\n      return sanitizeStylesheetInternal(\n          baseUri, cssText, virtualization,\n          naiveUriRewriter, undefined, undefined).result.toString();\n    };\n\n    sanitizeStylesheetWithExternals = function (\n        baseUri, cssText, virtualization, naiveUriRewriter, naiveUriFetcher,\n        continuation) {\n      return sanitizeStylesheetInternal(\n          baseUri, cssText, virtualization,\n          naiveUriRewriter, naiveUriFetcher, continuation);\n    };\n  })();\n})();\n\nexport {\n  sanitizeCssProperty,\n  sanitizeCssSelectorList,\n  sanitizeStylesheet,\n  sanitizeMediaQuery\n};\n"]}