{"version":3,"sources":["../../src/app/require-auth.js"],"names":["makeRequireAuthPresenter","presenter","deps","firebasePromise","Error","RequireAuthPresenter","props","authenticated","setState","isAuthed","isAuthenticated","auth","currentUser","isAnonymous","state","id","v4","then","firebase","config","ui","AuthUI","start","autoUpgradeAnonymousUsers","signInSuccessUrl","window","location","href","tosUrl","get","signInFlow","signInOptions","filter","p","map","email","EmailAuthProvider","PROVIDER_ID","google","GoogleAuthProvider","facebook","FacebookAuthProvider","twitter","TwitterAuthProvider","github","GithubAuthProvider","providerConfig","toJS","callbacks","signInSuccess","user","cred","redirectUrl","providerId","signInFailure","err","code","Promise","resolve","anonymousUser","credential","signInWithCredential","delete","renderPresenter"],"mappings":"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","file":"require-auth.js","sourcesContent":["import React, { Component } from 'react';\nimport firebaseui from 'firebaseui';\nimport uuid from 'uuid';\n\nimport 'firebaseui/dist/firebaseui.css';\n\nexport default function makeRequireAuthPresenter(presenter, deps) {\n  const firebasePromise = deps.firebasePromise;\n  if ( !firebasePromise ) {\n    return () => {\n      throw new Error('RequireAuthPresenter requires a firebasePromise dependency.  It should only be resolved once we have an auth state.');\n    };\n  }\n\n  class RequireAuthPresenter extends Component {\n    constructor(props) {\n      super(props);\n\n      this.state = {\n        id: `auth-${uuid.v4()}`, // element ids must start with a letter\n        isAuthed: false\n      };\n    }\n\n    authenticated = () => {\n      this.setState({\n        isAuthed: true\n      });\n    };\n\n    isAuthenticated = (auth) => (\n      // TODO: check roles, etc.\n      auth.currentUser && !auth.currentUser.isAnonymous\n    );\n\n    componentDidMount() {\n      firebasePromise.then(firebase => {\n        const auth = firebase.auth();\n        if ( this.isAuthenticated(auth) ) {\n          return this.authenticated();\n        }\n\n        const { config } = this.props;\n\n        // not authenticated yet\n        const ui = new firebaseui.auth.AuthUI(auth);\n        ui.start(\n          `#${this.state.id}`,\n          {\n            autoUpgradeAnonymousUsers: true,\n            signInSuccessUrl: window.location.href,\n            tosUrl: config.get('tosUrl'),\n            signInFlow: !!config.get('usePopup') ? 'popup' : 'redirect',\n            signInOptions: config.get('providers')\n                                 .filter(p => !!p)\n                                 .map(providerConfig => (\n                                   {\n                                     email: firebase.auth.EmailAuthProvider.PROVIDER_ID,\n                                     google: firebase.auth.GoogleAuthProvider.PROVIDER_ID,\n                                     facebook: firebase.auth.FacebookAuthProvider.PROVIDER_ID,\n                                     twitter: firebase.auth.TwitterAuthProvider.PROVIDER_ID,\n                                     github: firebase.auth.GithubAuthProvider.PROVIDER_ID\n                                   }[providerConfig.get('provider')]\n                                 ))\n                                 .filter(p => !!p)\n                                 .toJS(),\n            callbacks: {\n              signInSuccess: (user, cred, redirectUrl) => {\n                if ( cred && cred.providerId === 'google.com' ) {\n                  // cred.accessToken is the google oauth access token\n                }\n\n                this.authenticated();\n\n                return true;\n              },\n              signInFailure: (err) => {\n                if ( err.code !== 'firebaseui/anonymous-upgrade-merge-conflict' ) {\n                  return Promise.resolve();\n                }\n\n                const anonymousUser = auth.currentUser;\n                const cred = err.credential;\n\n                // TODO: actually copy data per https://github.com/firebase/firebaseui-web#using-firebaseui-for-authentication\n\n                return auth.signInWithCredential(cred)\n                           .then(_ => anonymousUser.delete())\n                           .then(_ => this.authenticated());\n              }\n            }\n          }\n        );\n      });\n    }\n\n    render() {\n      const { id, isAuthed } = this.state;\n      const { renderPresenter, config } = this.props;\n\n      if ( isAuthed ) {\n        return config.get('presenter') ? renderPresenter(config.get('presenter')) : null;\n      }\n\n      return (\n        <div>\n          {config.get('signInContent') ? renderPresenter(config.get('signInContent')) : null}\n          <div id={id} />\n        </div>\n      );\n    }\n  };\n\n  return presenter()(RequireAuthPresenter);\n}\n"]}