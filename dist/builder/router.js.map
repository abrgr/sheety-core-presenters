{"version":3,"sources":["../../src/builder/router.js"],"names":["makeRouterPresenter","presenter","RouterPresenter","props","onSetRoute","path","onUpdate","config","onSelectPresenterForEditing","route","selectedRoute","value","haveRoute","newRoutes","get","push","concat","size","setState","partialRoute","onSetParitalRoute","some","r","state","selectedPath","isEditing","renderPresenter","onEditAction","routes","selectedIdx","findIndex","routeDataSource","map","label","routeConfig","toJS","isNew","getIn","presenterPath","fuzzyFilter","text","textAlign","evt","stopPropagation","schema","getEventSchema","routePath","slice","baseEventSchema","routeParams","getAllRouteParams","mergeIn","param","title","type","params","re","match","exec"],"mappings":";;;;;;;;kBAQwBA,mB;;AARxB;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;AAEe,SAASA,mBAAT,CAA6BC,SAA7B,EAAwC;AAAA,MAC/CC,eAD+C;AAAA;;AAEnD,6BAAYC,KAAZ,EAAmB;AAAA;;AAAA,oIACXA,KADW;;AAAA,YA0FnBC,UA1FmB,GA0FN,yBAAiB;AAAA,0BACoC,MAAKD,KADzC;AAAA,YACpBE,IADoB,eACpBA,IADoB;AAAA,YACdC,QADc,eACdA,QADc;AAAA,YACJC,MADI,eACJA,MADI;AAAA,YACIC,2BADJ,eACIA,2BADJ;;;AAG5B,YAAMC,QAAQ,OAAOC,aAAP,KAAyB,QAAzB,GACAA,aADA,GAEAA,cAAcC,KAF5B;;AAIA,YAAK,CAAC,MAAKC,SAAL,CAAeH,KAAf,CAAN,EAA8B;AAC5B,cAAMI,YAAYN,OAAOO,GAAP,CAAW,QAAX,EAAqBC,IAArB,CAA0B,mBAAQ;AAClDV,kBAAMI,KAD4C;AAElDR,uBAAW;AAFuC,WAAR,CAA1B,CAAlB;;AAKAK,mBACED,KAAKW,MAAL,CAAY,CAAC,QAAD,EAAW,QAAX,CAAZ,CADF,EAEEH,SAFF;;AAKAL,sCAA4BH,KAAKW,MAAL,CAAY,CAAC,QAAD,EAAW,QAAX,EAAqBH,UAAUI,IAAV,GAAiB,CAAtC,EAAyC,WAAzC,CAAZ,CAA5B;AACD;;AAED,cAAKC,QAAL,CAAc;AACZR,yBAAeD,KADH;AAEZU,wBAAcV;AAFF,SAAd;AAID,OAnHkB;;AAAA,YAqHnBW,iBArHmB,GAqHC,wBAAgB;AAClC,cAAKF,QAAL,CAAc;AACZC;AADY,SAAd;AAGD,OAzHkB;;AAAA,YA2HnBP,SA3HmB,GA2HP;AAAA,eACV,MAAKT,KAAL,CAAWI,MAAX,CAAkBO,GAAlB,CAAsB,QAAtB,EAAgCO,IAAhC,CAAqC;AAAA,iBACnCC,EAAER,GAAF,CAAM,MAAN,MAAkBL,KADiB;AAAA,SAArC,CADU;AAAA,OA3HO;;AAEjB,YAAKc,KAAL,GAAa;AACXb,uBAAe,IADJ;AAEXS,sBAAc;AAFH,OAAb;AAFiB;AAMlB;;AARkD;AAAA;AAAA,+BAU1C;AAAA,qBAUH,KAAKhB,KAVF;AAAA,YAELE,IAFK,UAELA,IAFK;AAAA,YAGLmB,YAHK,UAGLA,YAHK;AAAA,YAILC,SAJK,UAILA,SAJK;AAAA,YAKLlB,MALK,UAKLA,MALK;AAAA,YAMLmB,eANK,UAMLA,eANK;AAAA,YAOLlB,2BAPK,UAOLA,2BAPK;AAAA,YAQLF,QARK,UAQLA,QARK;AAAA,YASLqB,YATK,UASLA,YATK;;AAWP,YAAMC,SAASrB,OAAOO,GAAP,CAAW,QAAX,CAAf;;AAXO,qBAaiC,KAAKS,KAbtC;AAAA,YAaCb,aAbD,UAaCA,aAbD;AAAA,YAagBS,YAbhB,UAagBA,YAbhB;;AAcP,YAAMU,cAAcD,OAAOE,SAAP,CAAiB;AAAA,iBAAKR,EAAER,GAAF,CAAM,MAAN,MAAkBJ,aAAvB;AAAA,SAAjB,CAApB;;AAEA,YAAMG,YAAY,CAACM,YAAD,IAAiB,KAAKP,SAAL,CAAeO,YAAf,CAAjB,GACA,EADA,GAEA,CAACA,YAAD,CAFlB;;AAIA,YAAMY,kBAAkBH,OAAOI,GAAP,CAAW;AAAA,iBAAgB;AACjDC,mBAAOC,YAAYpB,GAAZ,CAAgB,MAAhB,CAD0C;AAEjDH,mBAAOuB,YAAYpB,GAAZ,CAAgB,MAAhB;AAF0C,WAAhB;AAAA,SAAX,EAGpBqB,IAHoB,GAGbnB,MAHa,CAItBH,UAAUmB,GAAV,CAAc;AAAA,iBAAM;AAClBC,mBAAUX,CAAV,WADkB;AAElBX,mBAAOW,CAFW;AAGlBc,mBAAO;AAHW,WAAN;AAAA,SAAd,CAJsB,CAAxB;;AAWA,YAAMnC,YAAY2B,OAAOS,KAAP,CAAa,CAACR,WAAD,EAAc,WAAd,CAAb,CAAlB;AACA,YAAMS,gBAAgB,CAAC,QAAD,EAAW,QAAX,EAAqBT,WAArB,EAAkC,WAAlC,CAAtB;;AAEA,eACE;AAAA;AAAA;AACE;AACE,2BADF;AAEE,sBAAS,gBAFX;AAGE,+BAAkB,UAHpB;AAIE,0BAAc,KAAKzB,UAJrB;AAKE,2BAAe,KAAKgB,iBALtB;AAME,wBAAYD,YANd;AAOE,oBAAQ,uBAAaoB,WAPvB;AAQE,8BAAkB;AAChBC,oBAAM,OADU;AAEhB7B,qBAAO;AAFS,aARpB;AAYE,wBAAYoB,eAZd,GADF;AAcGN,sBAEG;AACE,oBAAQ,oBADV;AAEE,kBAAMpB,KAAKW,MAAL,CAAY,CAAC,QAAD,EAAW,QAAX,EAAqBa,WAArB,EAAkC,iBAAlC,CAAZ,CAFR;AAGE,uBAAW,oBAHb;AAIE,mBAAOD,OAAOS,KAAP,CAAa,CAACR,WAAD,EAAc,iBAAd,CAAb,CAJT;AAKE,sBAAUvB,QALZ;AAME,0BAAcqB,YANhB,GAFH,GASK,IAvBR;AAwBG;AACA,WAAC,CAAC1B,SAAF,IAAgB,CAAC,CAACuB,YAAF,IAAkB,0BAAWnB,KAAKW,MAAL,CAAYsB,aAAZ,CAAX,EAAuCd,YAAvC,CAAlC,GAEGE,gBAAgBY,aAAhB,EAA+BrC,SAA/B,CAFH,GAIG;AAAA;AAAA;AACE,qBAAO;AACLwC,2BAAW;AADN,eADT;AAIE;AAAA;AAAA;AACE,0BAAU,CAAChB,SADb;AAEE,yBAAS,iBAACiB,GAAD,EAAS;AAChBA,sBAAIC,eAAJ;AACAnC,8CAA4BH,KAAKW,MAAL,CAAYsB,aAAZ,CAA5B;AACD,iBALH;AAME;AANF;AAJF;AA7BN,SADF;AA8CD;AA1FkD;;AAAA;AAAA;;AAoIrD,SAAOrC,UAAU;AACf2C,YAAQ,uBAAO;AACb,iBAAW,gCADE;AAEb,aAAO,0DAFM;AAGb,eAAS,QAHI;AAIb,qBAAe,uHAJF;AAKb,cAAQ,QALK;AAMb,oBAAc;AACZ,cAAM;AACJ,mBAAS,YADL;AAEJ,yBAAe,qEAFX;AAGJ,kBAAQ,QAHJ;AAIJ,qBAAW;AAJP,SADM;AAOZ,gBAAQ;AACN,mBAAS,QADH;AAEN,qBAAW;AAFL,SAPI;AAWZ,kBAAU;AACR,mBAAS,eADD;AAER,yBAAe,6BAFP;AAGR,kBAAQ,QAHA;AAIR,qBAAW,EAJH;AAKR,wBAAc;AACZ,sBAAU;AACR,uBAAS,QADD;AAER,6BAAe,2FAFP;AAGR,yBAAW,EAHH;AAIR,sBAAQ,OAJA;AAKR,0BAAY,KALJ;AAMR,sCAAwB,IANhB;AAOR,uBAAS;AACP,yBAAS,OADF;AAEP,wBAAQ,QAFD;AAGP,8BAAc;AACZ,0BAAQ;AACN,6BAAS,MADH;AAEN,mCAAe,0QAFT;AAGN,4BAAQ,QAHF;AAIN,gCAAY;AAJN,mBADI;AAOZ,+BAAa;AACX,6BAAS,WADE;AAEX,mCAAe,gCAFJ;AAGX,4BAAQ,yEAHG;AAIX,gCAAY;AAJD,mBAPD;AAaZ,qCAAmB;AACjB,6BAAS,oBADQ;AAEjB,mCAAe,qCAFE;AAGjB,gCAAY,KAHK;AAIjB,4BAAQ;AAJS;AAbP;AAHP;AAPD;AADE;AALN;AAXE;AAND,KAAP,CADO;AA4DfC,oBAAgB,wBAACxC,IAAD,EAAOJ,SAAP,EAAqB;AACnC;AACA,UAAM6C,YAAY7C,UAAUoC,KAAV,CAAgBhC,KAAK0C,KAAL,CAAW,CAAX,EAAc,CAAC,CAAf,EAAkB/B,MAAlB,CAAyB,MAAzB,CAAhB,CAAlB;AACA,UAAMgC,kBAAkB,uBAAO;AAC7B,sBAAc;AACZ,sBAAY;AACV,qBAAS,yBADC;AAEV,oBAAQ;AAFE;AADA;AADe,OAAP,CAAxB;;AASA,UAAMC,cAAcC,kBAAkBJ,SAAlB,CAApB;;AAEA,aAAOE,gBAAgBG,OAAhB,CACL,CAAC,YAAD,CADK,EAEL,mBACEF,YAAYjB,GAAZ,CAAgB;AAAA,eAAU,CACxBoB,KADwB,EAExB,mBAAQ;AACNC,iBAAOD,KADD;AAENE,gBAAM;AAFA,SAAR,CAFwB,CAAV;AAAA,OAAhB,CADF,CAFK,CAAP;AAYD;AAtFc,GAAV,EAuFJpD,eAvFI,CAAP;AAwFD;;AAED,SAASgD,iBAAT,CAA2BzC,KAA3B,EAAkC;AAChC,MAAM8C,SAAS,EAAf;AACA,MAAMC,KAAK,cAAX;AACA,MAAIC,QAAQ,IAAZ;AACA,KAAG;AACDA,YAAQD,GAAGE,IAAH,CAAQjD,KAAR,CAAR;AACA,QAAK,CAAC,CAACgD,KAAP,EAAe;AACbF,aAAOxC,IAAP,CAAY0C,MAAM,CAAN,CAAZ;AACD;AACF,GALD,QAKU,CAAC,CAACA,KALZ;;AAOA,SAAO,oBAASF,MAAT,CAAP;AACD","file":"router.js","sourcesContent":["import React, { Component } from 'react';\nimport { fromJS, Map, List } from 'immutable';\nimport AutoComplete from 'material-ui/AutoComplete';\nimport EditPresenterIcon from 'material-ui/svg-icons/editor/border-inner';\nimport FloatingActionButton from 'material-ui/FloatingActionButton';\nimport equalPaths from './equal-paths';\nimport Action from '../configurer/action';\n\nexport default function makeRouterPresenter(presenter) {\n  class RouterPresenter extends Component {\n    constructor(props) {\n      super(props);\n      this.state = {\n        selectedRoute: null,\n        partialRoute: null\n      };\n    }\n\n    render() {\n      const {\n        path,\n        selectedPath,\n        isEditing,\n        config,\n        renderPresenter,\n        onSelectPresenterForEditing,\n        onUpdate,\n        onEditAction\n      } = this.props;\n      const routes = config.get('routes');\n\n      const { selectedRoute, partialRoute } = this.state;\n      const selectedIdx = routes.findIndex(r => r.get('path') === selectedRoute);\n\n      const newRoutes = !partialRoute || this.haveRoute(partialRoute)\n                      ? []\n                      : [partialRoute];\n\n      const routeDataSource = routes.map(routeConfig => ({\n        label: routeConfig.get('path'),\n        value: routeConfig.get('path')\n      })).toJS().concat(\n        newRoutes.map(r => ({\n          label: `${r} (New)`,\n          value: r,\n          isNew: true\n        }))\n      );\n\n      const presenter = routes.getIn([selectedIdx, 'presenter']);\n      const presenterPath = ['config', 'routes', selectedIdx, 'presenter'];\n\n      return (\n        <div>\n          <AutoComplete\n            fullWidth\n            hintText=\"/product/:name\"\n            floatingLabelText=\"URL Path\"\n            onNewRequest={this.onSetRoute}\n            onUpdateInput={this.onSetParitalRoute}\n            searchText={partialRoute}\n            filter={AutoComplete.fuzzyFilter}\n            dataSourceConfig={{\n              text: 'label',\n              value: 'value'\n            }}\n            dataSource={routeDataSource} />\n          {isEditing\n            ? (\n              <Action\n                schema={new Map()}\n                path={path.concat(['config', 'routes', selectedIdx, 'onRouteLaunched'])}\n                presenter={new Map()}\n                value={routes.getIn([selectedIdx, 'onRouteLaunched'])}\n                onUpdate={onUpdate}\n                onEditAction={onEditAction} />\n            ) : null}\n          {/* Render the presenter if we have one set or if we are editing it */\n           !!presenter || (!!selectedPath && equalPaths(path.concat(presenterPath), selectedPath))\n            ? (\n              renderPresenter(presenterPath, presenter)\n            ) : (\n              <div\n                style={{\n                  textAlign: 'center'\n                }}>\n                <FloatingActionButton\n                  disabled={!isEditing}\n                  onClick={(evt) => {\n                    evt.stopPropagation();\n                    onSelectPresenterForEditing(path.concat(presenterPath));\n                  }}>\n                  <EditPresenterIcon />\n                </FloatingActionButton>\n              </div>\n            )}\n        </div>\n      );\n    }\n\n    onSetRoute = selectedRoute => {\n      const { path, onUpdate, config, onSelectPresenterForEditing } = this.props;\n\n      const route = typeof selectedRoute === 'string'\n                  ? selectedRoute\n                  : selectedRoute.value;\n\n      if ( !this.haveRoute(route) ) {\n        const newRoutes = config.get('routes').push(new Map({\n          path: route,\n          presenter: null\n        }));\n\n        onUpdate(\n          path.concat(['config', 'routes']),\n          newRoutes\n        );\n\n        onSelectPresenterForEditing(path.concat(['config', 'routes', newRoutes.size - 1, 'presenter']));\n      }\n\n      this.setState({\n        selectedRoute: route,\n        partialRoute: route\n      });\n    };\n\n    onSetParitalRoute = partialRoute => {\n      this.setState({\n        partialRoute\n      });\n    };\n\n    haveRoute = route => (\n      this.props.config.get('routes').some(r => (\n        r.get('path') === route\n      ))\n    );\n  }\n\n  return presenter({\n    schema: fromJS({\n      \"$schema\": \"http://json-schema.org/schema#\",\n      \"$id\": \"http://sheetyapp.com/schemas/core-presenters/router.json\",\n      \"title\": \"Router\",\n      \"description\": \"Defines url routes and the presenters to render when the user navigates to those urls directly or by clicking a link.\",\n      \"type\": \"object\",\n      \"properties\": {\n        \"id\": {\n          \"title\": \"Identifier\",\n          \"description\": \"A unique identifier for this presenter.  Used for analytics events.\",\n          \"type\": \"string\",\n          \"default\": \"\"\n        },\n        \"type\": {\n          \"const\": \"router\",\n          \"default\": \"router\"\n        },\n        \"config\": {\n          \"title\": \"Configuration\",\n          \"description\": \"Pre-specified configuration\",\n          \"type\": \"object\",\n          \"default\": {},\n          \"properties\": {\n            \"routes\": {\n              \"title\": \"Routes\",\n              \"description\": \"A list of url parts and the presenter we should show when the user navigates to that url.\",\n              \"default\": [],\n              \"type\": \"array\",\n              \"linkable\": false,\n              \"internallyConfigured\": true,\n              \"items\": {\n                \"title\": \"Route\",\n                \"type\": \"object\",\n                \"properties\": {\n                  \"path\": {\n                    \"title\": \"Path\",\n                    \"description\": \"The path for this route (the thing you see in the address bar).  You can use /path/{'My Tab'!A1}/{'My Tab'!B2} so that, if the user navigates to /path/something/else, 'something' is written to cell A1 in tab, My Tab, and 'else' is writte to cell B2 in tab, My Tab.\",\n                    \"type\": \"string\",\n                    \"linkable\": false\n                  },\n                  \"presenter\": {\n                    \"title\": \"Presenter\",\n                    \"description\": \"Presenter to show at this url.\",\n                    \"$ref\": \"http://sheetyapp.com/schemas/core-presenters/configurers/presenter.json\",\n                    \"linkable\": false\n                  },\n                  \"onRouteLaunched\": {\n                    \"title\": \"Page Loaded Action\",\n                    \"description\": \"Action to fire when this page loads\",\n                    \"linkable\": false,\n                    \"$ref\": \"http://sheetyapp.com/schemas/core-presenters/configurers/action.json\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }),\n    getEventSchema: (path, presenter) => {\n      // path refers to config/routes/{n}/onRouteLaunched\n      const routePath = presenter.getIn(path.slice(0, -1).concat('path'));\n      const baseEventSchema = fromJS({\n        \"properties\": {\n          \"fullPath\": {\n            \"title\": \"Full path for this page\",\n            \"type\": \"string\"\n          }\n        }\n      });\n\n      const routeParams = getAllRouteParams(routePath);\n\n      return baseEventSchema.mergeIn(\n        ['properties'],\n        new Map(\n          routeParams.map(param => ([\n            param,\n            new Map({\n              title: param,\n              type: 'string'\n            })\n          ]))\n        )\n      );\n    }\n  })(RouterPresenter);\n}\n\nfunction getAllRouteParams(route) {\n  const params = [];\n  const re = /\\/:([^\\/]+)/g;\n  let match = null;\n  do {\n    match = re.exec(route);\n    if ( !!match ) {\n      params.push(match[1]);\n    }\n  } while ( !!match );\n\n  return new List(params);\n}\n"]}